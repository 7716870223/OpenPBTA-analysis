---
title: "Evaluate concordance between Mutect2 and Strelka2"
output:   
  html_notebook: 
    toc: true
    toc_float: true
---

Candace Savonen - CCDL for ALSF

This notebook is the second notebook in this analysis and makes a bunch of plots
is a first pass in evaluating the concordance between MuTect2 and Strelka2 
results.

It addresses [issue \# 30 in OpenPBTA](https://github.com/AlexsLemonade/OpenPBTA-analysis/issues/30).

## Usage

To run this from the command line, use:
```
Rscript -e "rmarkdown::render('analyses/mutect2-vs-strelka2/01-set-up.Rmd', 
                              clean = TRUE)"
```

 _This assumes you are in the top directory of the repository._
 
## Set Up

```{r}
# Get magrittr pipe
`%>%` <- dplyr::`%>%`
```

Read in the dataset set up in `01-set-up.Rmd`.

```{r}
vaf_df <- readr::read_tsv(file.path("results", "combined_results.tsv"))
```

## VAF scatterplot

```{r}
vaf_df %>%
ggplot2::ggplot(ggplot2::aes(x = vaf.strelka2, y = vaf.mutect2)) + 
  ggplot2::geom_hex() +
  ggplot2::theme_classic() + 
  ggplot2::xlab("VAF for each mutation for Strelka2") + 
  ggplot2::ylab("VAF for each mutation for MuTect2") 
```

## VAF Violin plots

```{r}
vaf_df %>%
  tidyr::gather(key = "data", value = "vaf" , vaf.strelka2, vaf.mutect2) %>%
  dplyr::mutate(data = gsub("^vaf.", "", data)) %>% 
  dplyr::mutate(data.group = paste(dataset, ":", data, "VAF")) %>%
  dplyr::filter(!is.na(vaf)) %>%
# Plot it
ggplot2::ggplot(ggplot2::aes(data.group, vaf)) + 
  ggplot2::geom_violin(fill = "light blue") +
  ggplot2::theme_classic( ) + 
  ggplot2::ylab("Density of VAF") + 
  ggplot2::xlab(" ")
```

## Venn Diagrams

Make the Venn diagram of MuTect2 and Strelka2 mutations. 

```{r}
count <- summary(as.factor(vaf_df$dataset))

# Take a look at this summary
count
```

```{r}
# Make the Venn diagram
grid::grid.newpage();
venn.plot <- VennDiagram::draw.pairwise.venn(
  area1 = count[3] + count[1],
  area2 = count[2] + count[1],
  cross.area = count[1],
  category = c("Strelka2", "MuTect2"),
  fill = c("blue", "yellow"),
  cex = 2,
  cat.cex = 1.5,
  cat.dist = c(-0.04, -0.031),
  ext.pos = 0,
  ext.dist = -0.01,
  ext.length = .8,
  ext.line.lwd = 2,
  ext.line.lty = "dashed");
grid::grid.draw(venn.plot) # Draw plot
```

Save the Venn Diagram plot to a PDF. 

```{r}
# Make filename to save plot as
venn.plot.file <- file.path("plots", 
                            "strelka2_mutect2_venn_diagram.pdf")
pdf(venn.plot.file);
grid::grid.draw(venn.plot);
dev.off()
```

## What types of variants are are the most discrepant between the algorithms?

Let's make a wrapper function that will do this for whatever variables we are 
interested in. 

```{r}
barplot_var <- function(df = vaf_df, variable_name = "change", filter_cutoff = 0, 
                        as_percent = TRUE, omit.na = FALSE) {
  # Creates a ggplot barplot for the numbers of mutations that fall into each 
  # category of the variable selected. 
  #
  # Args:
  #   df: combined data.frame with both datasets (vaf_df)
  #   variable_name: a character string that indicates the base variable name 
  #                  from the original MAF file
  #   filter_cutoff: variable categories with less than this cutoff will be removed
  #   as_percent: If true, will report numbers as percentages of the group they 
  #               are from
  #   omit.na: If true, will remove NA's as a category
  #
  # Returns:
  #   ggplot2 grouped barplot with mutect_only, strelka2_only, and both as groups
  
  # Reconfigure dataset based on chosen variable, get numbers of mutations for 
  # each dataset and variable category
  count_df <- df %>%
    dplyr::select(paste0(variable_name, c(".strelka2", ".mutect2")),
                  dataset) %>%
    tidyr::gather(key = "data", value = "variable" , 
                  paste0(variable_name, c(".strelka2", ".mutect2"))) %>%
    dplyr::mutate('data' = gsub(paste0(variable_name, "."), "", data)) %>%
    dplyr::group_by(dataset, data, variable) %>% 
    dplyr::summarise(count = dplyr::n())
  
  # Calculate sum totals for each data group
  totals <- count_df %>%
    dplyr::group_by(dataset) %>%
    dplyr::summarise(total = sum(count, na.rm = TRUE)) 
   
  # Calculate percentages based on totals and apply filter_cutoff 
  count_df <- count_df %>%
    as.data.frame() %>%
    dplyr::mutate("percent" = count_df$count/totals$total[match(count_df$dataset, 
                                                                totals$dataset)]) %>%
    dplyr::mutate(report = ifelse(rep(as_percent, nrow(count_df)), percent, count)) %>%
    dplyr::filter(report > filter_cutoff) 
  
  # Omit NAs if that was specified
  if (omit.na){
    count_df <- dplyr::filter(count_df, !is.na(variable))
  }

    # Plot this!
    ggplot2::ggplot(count_df, ggplot2::aes(x = reorder(variable, -report), 
                                 y = report, fill = dataset)) + 
    ggplot2::geom_bar(position = "dodge", stat="identity") + 
    ggplot2::theme_classic() +
    ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, hjust = 1)) +
    colorblindr::scale_fill_OkabeIto() + 
    ggplot2::xlab("") +
    ggplot2::ylab(ifelse(as_percent, "Percent of Data Group", "Count"))
}
```

```{r}
barplot_var(df = vaf_df, variable_name = "change", 
            as_percent = FALSE, omit.na = TRUE, filter_cutoff = 0)
```

```{r}
barplot_var(df = vaf_df, variable_name = "change", filter_cutoff = 0, 
            as_percent = TRUE, omit.na = TRUE)
```

```{r}
barplot_var(df = vaf_df, variable_name = "coding", filter_cutoff = .001, 
            as_percent = TRUE, omit.na = TRUE)
```

```{r}
barplot_var(df = vaf_df, variable_name = "IMPACT", filter_cutoff = .001, 
            as_percent = TRUE, omit.na = TRUE)
```

```{r}
barplot_var(df = vaf_df, variable_name = "Allele", filter_cutoff = .001, 
            as_percent = TRUE, omit.na = TRUE)
```
Session Info: 

```{r}
sessionInfo()
```