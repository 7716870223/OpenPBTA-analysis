---
title: "Evaluate concordance between Mutect2 and Strelka2"
output:   
  html_notebook: 
    toc: true
    toc_float: true
---

Candace Savonen - CCDL for ALSF

This notebook is a first pass in evaluating the concordance between MuTect2 and 
Strelka2 results.

It addresses [issue \# 30 in OpenPBTA](https://github.com/AlexsLemonade/OpenPBTA-analysis/issues/30).

## Set Up

\* Some of these set up steps will be removed once we have a Dockerfile that installs
maftools automatically. 

```{r}
# We need maftools - this will be added to the running Docker issue whenever it is up
if (!('maftools' %in% installed.packages())) {
  devtools::install_github("PoisonAlien/maftools")
}

if (!('hexbin' %in% installed.packages())) {
  install.packages("hexbin")
}

if (!('colorblindr' %in% installed.packages())) {
  devtools::install_github("clauswilke/colorblindr")
}
# Get magrittr pipe
`%>%` <- dplyr::`%>%`
```

Create a output directories.

```{r}
if (!dir.exists("results")) {
  dir.create("results")
}
if (!dir.exists("plots")) {
  dir.create("plots")
}
```

## Read in the metadata information
This will be changed once the [data download script](https://github.com/AlexsLemonade/OpenPBTA-analysis/issues/2) is finalized. 

Prep the metadata to be used as the `clinicalData` for maftools it it hasn't been 
prepped yet. 
This whole chunk may need to be removed be taken out after issue 2 regarding the [data download script](https://github.com/AlexsLemonade/OpenPBTA-analysis/issues/2) is addressed. 

These steps are only to make the metadata and MuTect2 and Strelka2 datasets 
parallel in what samples they contain.  
There are some samples in the metadata that are not in the MuTect2 and Strelka2
data. 

```{r}
if (file.exists(file.path("..", "..", "scratch", "metadata_filtered.tsv"))) {
  metadata <- readr::read_tsv(file.path("..", "..", "scratch", "metadata_filtered.tsv"))
}
```

## Read in the Strelka2 and Mutect2 data

Will read in as an `maftools` object from an RDS file, unless `maftools` has not been 
run on them yet.
Running `maftools` takes a lot of computing power and time, so be prepared.
If you trying to run this step in a Docker container, it will likely be out of 
memory killed, unless you have ~50GB you can allot to Docker. 

```{r}
# Load in the RDS file if it exists, but if it doesn't exist, load in from 
# original data file with maftools
if (!file.exists(file.path("..", "..", "scratch", "strelka2.RDS"))) {
  strelka <- maftools::read.maf(file.path("..", "..", "data", "strelka2.maf.gz"),
                                clinicalData = metadata)
  saveRDS(strelka, file.path("..", "..", "scratch", "strelka2.RDS"))
} else {
  strelka2 <- readRDS(file.path("..", "..", "scratch", "strelka2.RDS"))
}

# Same for MuTect2
if (!file.exists(file.path("..", "..", "scratch", "mutect2.RDS"))) {
  mutect2 <- maftools::read.maf(file.path("..", "..", "data", "mutect2.maf.gz"), 
                                clinicalData = metadata)
  saveRDS(mutect2, file.path("..", "..", "scratch", "mutect2.RDS"))
} else {
  mutect2 <- readRDS(file.path("..", "..", "scratch", "mutect2.RDS"))
}
```

This is how I set up `metadata_filtered.tsv`. 
This should not need to be ran again and won't run again unless 
`metadata_filtered.tsv` is misplaced from the scratch file. 

```{r}
if (!file.exists(file.path("..", "..", "scratch", "metadata_filtered.tsv"))) {
  # Isolate metadata to only the samples that are in the datasets
  metadata <- metadata %>%
    dplyr::filter(sample_id %in% mutect2@clinical.data$Tumor_Sample_Barcode) %>%
    dplyr::distinct(sample_id, .keep_all = TRUE) %>%
    readr::write_tsv(file.path("..", "..", "scratch", "metadata_filtered.tsv"))
}
```

Check that samples are same order in the datasets as they are in the metadata

```{r}
all.equal(as.factor(metadata$sample_id),
          strelka2@clinical.data$Tumor_Sample_Barcode)

all.equal(as.factor(metadata$sample_id), 
          mutect2@clinical.data$Tumor_Sample_Barcode)
```

## Get summaries and write them to TSVs 

Get gene summaries and write to TSV files. 

```{r}
strelka2_gene_sum <- maftools::getGeneSummary(strelka2) %>% 
  readr::write_tsv(file.path("results", 
                             "strelka2_gene_summary.tsv"))

mutect2_gene_sum <- maftools::getGeneSummary(mutect2) %>% 
  readr::write_tsv(file.path("results", 
                             "mutect2_gene_summary.tsv"))
```

Get sample summaries and write to TSV files. 

```{r}
strelka2_sample_sum <- maftools::getSampleSummary(strelka2) %>% 
  readr::write_tsv(file.path("results", 
                             "strelka2_sample_summary.tsv"))

mutect2_sample_sum <- maftools::getSampleSummary(mutect2) %>% 
  readr::write_tsv(file.path("results", 
                             "mutect2_sample_summary.tsv"))
```

## Number of mutations per gene correlation 

```{r}
combined_gene <- mutect2_gene_sum %>% 
  dplyr::full_join(strelka2_gene_sum, by = 'Hugo_Symbol') %>%
  reshape2::melt(id = 'Hugo_Symbol') %>% 
  dplyr::mutate(dataset = as.character(grepl(".x$", variable))) %>%
  dplyr::mutate(dataset = dplyr::recode(dataset, 
                                        `TRUE` = "mutect2", 
                                        `FALSE` = "strelka2")) %>%
  dplyr::mutate(variable = gsub(".x$|.y$", "", variable)) %>% 
  tidyr::spread('dataset', 'value')
```

Let's get a correlation test on the genes overall.

```{r}
cor.test(combined_gene$mutect2, combined_gene$strelka2, method = "spearman")
cor.test(combined_gene$mutect2, combined_gene$strelka2, method = "pearson")
```

## Number of mutations per sample correlation. 

```{r}
combined_sample <- mutect2_sample_sum %>% 
  dplyr::full_join(strelka2_sample_sum, by = 'Tumor_Sample_Barcode') %>%
  reshape2::melt(id = 'Tumor_Sample_Barcode') %>% 
  dplyr::mutate(dataset = as.character(grepl(".x$", variable))) %>%
  dplyr::mutate(dataset = dplyr::recode(dataset, 
                                        `TRUE` = "mutect2", 
                                        `FALSE` = "strelka2")) %>%
  dplyr::mutate(variable = gsub(".x$|.y$", "", variable)) %>% 
  tidyr::spread('dataset', 'value')
```

Let's get a correlation test on the genes overall.

```{r}
cor.test(combined_sample$mutect2, combined_sample$strelka2, method = "spearman")
cor.test(combined_sample$mutect2, combined_sample$strelka2, method = "pearson")
```

## Set up new variables

Here we will make these new variables for both Mutect2 and Strelka2 dataset:
- Calculate VAF for each
- Make a mutation ID by concatenating gene name, allele, tumor ID, and start position
- Summarize the biotype variable for whether or not it is a coding gene. 

Let's do this for Strelka2 first. 

```{r}
strelka2_vaf <- strelka2@data %>%
  dplyr::mutate(vaf = as.numeric(t_alt_count)/(as.numeric(t_ref_count) + 
                                                 as.numeric(t_alt_count)),
                mutation = paste0(Hugo_Symbol, "_", 
                                  Allele, "_", 
                                  Tumor_Sample_Barcode, "_", 
                                  Start_Position), 
                change = paste0(Reference_Allele, ">", Allele),
                coding = dplyr::case_when( 
                  BIOTYPE != "protein_coding" ~ "non-coding",
                  TRUE ~ "protein_coding")) %>%
    dplyr::select(-which(apply(is.na(.), 2, all)))

# Take a look at this df
strelka2_vaf
```

Now we will do the same for MuTect2.

```{r}
mutect2_vaf <- mutect2@data %>%
  dplyr::mutate(vaf = as.numeric(t_alt_count)/(as.numeric(t_ref_count) + 
                                                 as.numeric(t_alt_count)),
                mutation = paste0(Hugo_Symbol, "_", 
                                  Allele, "_", 
                                  Tumor_Sample_Barcode, "_", 
                                  Start_Position),
                change = paste0(Reference_Allele, ">", Allele), 
                coding = dplyr::case_when( 
                  BIOTYPE != "protein_coding" ~ "non-coding",
                  TRUE ~ "protein_coding")) %>%
  dplyr::select(-which(apply(is.na(.), 2, all)))

# Take a look at this df
mutect2_vaf
```

## Combine MuTect2 and Strelka2 data.frames into one data.frame

Save to a TSV file

```{r}
# Merge these data.frames together
vaf_df <- strelka2_vaf %>%
  dplyr::full_join(mutect2_vaf, by = 'mutation', 
                    suffix = c(".strelka2", ".mutect2")) %>%
  # Make a variable that denotes which dataset it is in.
  dplyr::mutate(dataset = dplyr::case_when( 
    is.na(vaf.mutect2) ~ "strelka2_only",
    is.na(vaf.strelka2) ~ "mutect2_only", 
    TRUE ~ "both")) %>%
  readr::write_tsv(file.path("results", "combined_results.tsv"))
```

Session Info: 

```{r}
sessionInfo()
```
